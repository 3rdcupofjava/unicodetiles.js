<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Simple Dungeon</title>
	<link href="../unicodetiles/unicodetiles.css" rel="stylesheet" type="text/css" />
	<link href="style.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="../unicodetiles/unicodetiles.js"></script>
	<script type="text/javascript" src="../unicodetiles/input.js"></script>
	<script type="text/javascript">
		var term, eng; // Can't be initialized yet because DOM is not ready
		var pl = { x: 3, y: 2 };
		var map = [
			"##############################",
			"##   ###############   #######",
			"##          ########      ####",
			"##   ###### ########  ### ####",
			"########### ############# ####",
			"########### ############     #",
			"########### ############     #",
			"########### ############     #",
			"###########                  #",
			"############## ###############",
			"############## #######    ####",
			"#        ##### ####### #  ####",
			"#  ####   #### ####### #######",
			"#         #### ####### #######",
			"#         #### #######      ##",
			"## ########### #######      ##",
			"## ########### ########### ###",
			"## ########### ########### ###",
			"## ########### ########### ###",
			"## #####       ########### ###",
			"## #####     # ########### ###",
			"## #####     # ########### ###",
			"## #####     # ########### ###",
			"## #####     # ########### ###",
			"## ########### ########### ###",
			"## ########### ########### ###",
			"## ###########             ###",
			"## ############# #############",
			"##               #############",
			"##############################"
		];

		function getDungeonTile(x, y) {
			x = Math.round(x), y = Math.round(y);
			var t = "";
			try { t = map[y][x]; }
			catch(err) { return new ut.Tile(t); }
			if (t === '#') return new ut.Tile('#', 100, 100, 100);
			return new ut.Tile(t);
		}

		function calculateFov(x, y) {
			var distx = x - pl.x, disty = y - pl.y;
			var maxdist = Math.max(Math.abs(distx), Math.abs(disty));
			var dx = distx / maxdist, dy = disty / maxdist;
			var xx = pl.x, yy = pl.y;
			for (var i = 0; i < maxdist; ++i) {
				if (getDungeonTile(xx,yy).getChar() === "#")
					return false;
				xx += dx; yy += dy;
			}
			return true;
		}

		function start() {
			window.setInterval("tick()", 150);
			term = new ut.Viewport(document.getElementById("game"), 41, 25);
			eng = new ut.Engine(term, getDungeonTile);
			eng.setMaskFunc(calculateFov);
		}

		function handleKeys() {
			var oldx = pl.x, oldy = pl.y;
			if (pressedKeys[KEY_LEFT])  pl.x--;
			if (pressedKeys[KEY_RIGHT]) pl.x++;
			if (pressedKeys[KEY_UP])    pl.y--;
			if (pressedKeys[KEY_DOWN])  pl.y++;
			if (getDungeonTile(pl.x, pl.y).getChar() === '#') { pl.x = oldx; pl.y = oldy; }
		}

		function tick() {
			handleKeys(); // Input
			eng.update(pl.x, pl.y); // Update tiles
			term.put(new ut.Tile("@", 255, 255, 255), term.cx, term.cy); // Player character
			term.render(); // Render
		}
	</script> 
</head>

<body onload="start();"><div id="container">

	<p class="centerer">Move around with arrow keys.</p>

	<div class="centerer">
		<div id="game"></div>
	</div>

</div></body>
</html>
